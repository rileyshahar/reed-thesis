%pic\usepackage{etoolbox}
% from broadbent-karvonnen on arxiv

\usepackage{tikz}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{decorations.markings}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{shapes.geometric}
\tikzset{>={To[length=2.5pt,width=4pt]}}

\usetikzlibrary{intersections}

\newenvironment{pic}[1][]
{\begin{aligned}\begin{tikzpicture}[font=\tiny,#1]}
{\end{tikzpicture}\end{aligned}}


% Layers
\pgfdeclarelayer{foreground}
\pgfdeclarelayer{background}
\pgfdeclarelayer{morphismlayer}
\pgfdeclarelayer{dashedmorphismlayer}
\pgfdeclarelayer{edgelayer}
\pgfdeclarelayer{nodelayer}
\pgfsetlayers{background,main,morphismlayer,dashedmorphismlayer,foreground,edgelayer,nodelayer}

% Styles
\def\thickness{0.7pt}
\makeatletter
\pgfkeys{%
  /tikz/on layer/.code={
    \pgfonlayer{#1}\begingroup
    \aftergroup\endpgfonlayer
    \aftergroup\endgroup
  },
  /tikz/node on layer/.code={
    \gdef\node@@on@layer{%
      \setbox\tikz@tempbox=\hbox\bgroup\pgfonlayer{#1}\unhbox\tikz@tempbox\endpgfonlayer\pgfsetlinewidth{\thickness}\egroup}
    \aftergroup\node@on@layer
  },
  /tikz/end node on layer/.code={
    \endpgfonlayer\endgroup\endgroup
  }
}
\def\node@on@layer{\aftergroup\node@@on@layer}
\makeatother

\tikzstyle{braid}=[double=black, line width=3*\thickness, double distance=\thickness, draw=white, text=black]
\tikzset{every picture/.style={line width=\thickness, draw=black}}
\tikzstyle{pure}=[line width=.7pt]
\tikzstyle{string}=[line width=\thickness]
\tikzstyle{scalar}=[circle, inner sep=0pt, minimum width=15pt, draw, line width=\thickness, fill=white]
\tikzstyle{dot}=[circle, draw=black, fill=black!25, inner sep=.4ex, line width=\thickness, node on layer=foreground]
\tikzstyle{blackdot}=[circle, draw=black, fill=black!75, inner sep=.4ex, line width=\thickness, node on layer=foreground, text=white]
\tikzstyle{whitedot}=[circle, draw=black, fill=white, inner sep=.4ex, line width=\thickness, node on layer=foreground]
\tikzstyle{mixedmorphism}=[morphism, minimum width=30pt, minimum height=16pt, draw, font=\small, inner sep=0pt, fill=white, line width=\thickness,rounded corners=1ex]

\tikzstyle{triangle} = [regular polygon, regular polygon sides=3, draw=black, fill=black!20,scale=0.4, node on layer=foreground]

\tikzstyle{whitetriangle}=[triangle, fill=white]
\tikzstyle{greytriangle}=[triangle, fill=black!20]
\tikzstyle{darkgreytriangle}=[triangle, fill=black!50]
\tikzstyle{blacktriangle}=[triangle, fill=black]

\tikzstyle{invertedtriangle} = [triangle,scale=-1]
\tikzstyle{whiteinvertedtriangle}=[invertedtriangle, fill=white]
\tikzstyle{greyinvertedtriangle}=[invertedtriangle, fill=black!20]
\tikzstyle{darkgreyinvertedtriangle}=[invertedtriangle, fill=black!50]
\tikzstyle{blackinvertedtriangle}=[invertedtriangle, fill=black]

\tikzset{functor1/.style={gray!50}}
\tikzset{functor2/.style={gray!50}}
\tikzstyle{thick}=[line width=\thickness]
\tikzstyle{tiny}=[font=\tiny]
%\newcommand{\twist}[1][]{\ensuremath{\theta_{#1}}}
%\tikzset{twist/.style={circle, draw=black, fill=white, line width=\thickness, inner sep=2pt, font=\small, node contents={$\twist$}}}
\tikzset{circlelabel/.style={draw, thick, circle, inner sep=-5pt,
 fill=white, minimum width=14pt, fill opacity=1, node on layer=foreground, font=\scriptsize}}
\tikzset{shade 1 transparent/.style={fill=black!20, fill opacity=0.8}}
\tikzset{shade 2 transparent/.style={fill=black!35, fill opacity=0.8}}
\tikzset{shade 3 transparent/.style={fill=black!50, fill opacity=0.8}}
\tikzset{shade 4 transparent/.style={fill=black!65, fill opacity=0.8}}
\tikzset{shade 1/.style={fill=black!16, fill opacity=1}}
\tikzset{shade 2/.style={fill=black!28, fill opacity=1}}
\tikzset{shade 3/.style={fill=black!40, fill opacity=1}}
\tikzset{shade 4/.style={fill=black!52, fill opacity=1}}
\def\sideangle{30}
\def\nwangle{180-\sideangle}
\def\neangle{\sideangle}
\def\swangle{180+\sideangle}
\def\seangle{-\sideangle}
\def\offangle{10}

\def\strarr{line width=0.7pt, length=4pt, width=5pt, color=black}

% Arrows
% \ignore{
\tikzset{arrow/.style={decoration={
    markings,
    mark=at position #1 with \arrow{>[\strarr]}},
    postaction=decorate},
    reverse arrow/.style={decoration={
    markings,
    mark=at position #1 with {{\arrow{<[\strarr]}}}},
    postaction=decorate}
}
% }
% \tikzset{arrow/.style={},
    % reverse arrow/.style={}
% }

% Braces
\tikzset{overbrace/.style={
     decoration={brace},
     decorate}
}
\tikzset{underbrace/.style={
     decoration={brace, mirror},
     decorate}
}

% Keys
\newif\ifblack\pgfkeys{/tikz/black/.is if=black}
\newif\ifwedge\pgfkeys{/tikz/wedge/.is if=wedge}
\newif\ifvflip\pgfkeys{/tikz/vflip/.is if=vflip}
\newif\ifhflip\pgfkeys{/tikz/hflip/.is if=hflip}
\newif\ifhvflip\pgfkeys{/tikz/hvflip/.is if=hvflip}
\newif\ifconnectsw\pgfkeys{/tikz/connect sw/.is if=connectsw}
\newif\ifconnectse\pgfkeys{/tikz/connect se/.is if=connectse}
\newif\ifconnectn\pgfkeys{/tikz/connect n/.is if=connectn}
\newif\ifconnects\pgfkeys{/tikz/connect s/.is if=connects}
\newif\ifconnectnw\pgfkeys{/tikz/connect nw/.is if=connectnw}
\newif\ifconnectne\pgfkeys{/tikz/connect ne/.is if=connectne}
\newif\ifconnectnwf\pgfkeys{/tikz/connect nw >/.is if=connectnwf}
\newif\ifconnectnef\pgfkeys{/tikz/connect ne >/.is if=connectnef}
\newif\ifconnectswf\pgfkeys{/tikz/connect sw >/.is if=connectswf}
\newif\ifconnectsef\pgfkeys{/tikz/connect se >/.is if=connectsef}
\newif\ifconnectnf\pgfkeys{/tikz/connect n >/.is if=connectnf}
\newif\ifconnectsf\pgfkeys{/tikz/connect s >/.is if=connectsf}
\newif\ifconnectnwr\pgfkeys{/tikz/connect nw </.is if=connectnwr}
\newif\ifconnectner\pgfkeys{/tikz/connect ne </.is if=connectner}
\newif\ifconnectswr\pgfkeys{/tikz/connect sw </.is if=connectswr}
\newif\ifconnectser\pgfkeys{/tikz/connect se </.is if=connectser}
\newif\ifconnectnr\pgfkeys{/tikz/connect n </.is if=connectnr}
\newif\ifconnectsr\pgfkeys{/tikz/connect s </.is if=connectsr}
\tikzset{keylengthnw/.initial=\connectheight}
\tikzset{keylengthn/.initial =\connectheight}
\tikzset{keylengthne/.initial=\connectheight}
\tikzset{keylengthsw/.initial=\connectheight}
\tikzset{keylengths/.initial =\connectheight}
\tikzset{keylengthse/.initial=\connectheight}
\tikzset{connect nw length/.style={connect nw=true, keylengthnw={#1}}}
\tikzset{connect n length/.style ={connect n =true, keylengthn ={#1}}}
\tikzset{connect ne length/.style={connect ne=true, keylengthne={#1}}}
\tikzset{connect sw length/.style={connect sw=true, keylengthsw={#1}}}
\tikzset{connect s length/.style ={connect s =true, keylengths ={#1}}}
\tikzset{connect se length/.style={connect se=true, keylengthse={#1}}}
\tikzset{connect nw < length/.style={connect nw <=true, keylengthnw={#1}}}
\tikzset{connect n < length/.style ={connect n <=true,  keylengthn ={#1}}}
\tikzset{connect ne < length/.style={connect ne <=true, keylengthne={#1}}}
\tikzset{connect sw < length/.style={connect sw <=true, keylengthnw={#1}}}
\tikzset{connect s < length/.style ={connect s <=true,  keylengths ={#1}}}
\tikzset{connect se < length/.style={connect se <=true, keylengthse={#1}}}
\tikzset{connect nw > length/.style={connect nw >=true, keylengthnw={#1}}}
\tikzset{connect n > length/.style ={connect n >=true,  keylengthn ={#1}}}
\tikzset{connect ne > length/.style={connect ne >=true, keylengthne={#1}}}
\tikzset{connect sw > length/.style={connect sw >=true, keylengthsw={#1}}}
\tikzset{connect s > length/.style ={connect s >=true,  keylengths ={#1}}}
\tikzset{connect se > length/.style={connect se >=true, keylengthse={#1}}}

% Lengths
\newlength\morphismheight
\setlength\morphismheight{0.6cm}
\newlength\wedgewidth
\setlength\wedgewidth{10pt}
\newlength\minimummorphismwidth
\setlength\minimummorphismwidth{0.3cm}
\newlength\stateheight
\setlength\stateheight{0.6cm}
\newlength\minimumstatewidth
\setlength\minimumstatewidth{0.89cm}
\newlength\connectheight
\setlength\connectheight{0.5cm}
\tikzset{width/.initial=\minimummorphismwidth}
\tikzset{colour/.initial=white}

% Custom arrowhead
\makeatletter
\pgfarrowsdeclare{thickarrow}{thickarrow}
{
  \pgfutil@tempdima=-0.84pt%
  \advance\pgfutil@tempdima by-1.3\pgflinewidth%
  \pgfutil@tempdimb=-1.7pt%
  \advance\pgfutil@tempdimb by.625\pgflinewidth%
  \pgfarrowsleftextend{+\pgfutil@tempdima}
  \pgfarrowsrightextend{+\pgfutil@tempdimb}
}
{
  \pgfmathparse{\pgfgetarrowoptions{thickarrow}}%
  \pgfsetlinewidth{1.25 pt}
  \pgfutil@tempdima=0.28pt%
  \advance\pgfutil@tempdima by.3\pgflinewidth%
  \pgfsetlinewidth{0.8\pgflinewidth}
  \pgfsetdash{}{+0pt}
  \pgfsetroundcap
  \pgfsetroundjoin
  \pgfpathmoveto{\pgfqpoint{-3\pgfutil@tempdima}{4\pgfutil@tempdima}}
  \pgfpathcurveto
  {\pgfqpoint{-2.75\pgfutil@tempdima}{2.5\pgfutil@tempdima}}
  {\pgfqpoint{0pt}{0.25\pgfutil@tempdima}}
  {\pgfqpoint{0.75\pgfutil@tempdima}{0pt}}
  \pgfpathcurveto
  {\pgfqpoint{0pt}{-0.25\pgfutil@tempdima}}
  {\pgfqpoint{-2.75\pgfutil@tempdima}{-2.5\pgfutil@tempdima}}
  {\pgfqpoint{-3\pgfutil@tempdima}{-4\pgfutil@tempdima}}
  \pgfusepathqstroke
}
\pgfarrowsdeclare{reversethickarrow}{reversethickarrow}
{
  \pgfutil@tempdima=-0.84pt%
  \advance\pgfutil@tempdima by-1.3\pgflinewidth%
  \pgfutil@tempdimb=0.2pt%
  \advance\pgfutil@tempdimb by.625\pgflinewidth%
  \pgfarrowsleftextend{+\pgfutil@tempdima}
  \pgfarrowsrightextend{+\pgfutil@tempdimb}
}
{
  \pgftransformxscale{-1}
  \pgfmathparse{\pgfgetarrowoptions{thickarrow}}%
  \ifpgfmathunitsdeclared%
    \pgfmathparse{\pgfmathresult pt}%
  \else%  
    \pgfmathparse{\pgfmathresult*\pgflinewidth}%
  \fi%
  \let\thickness=\pgfmathresult
  \pgfsetlinewidth{1.25 pt}
  \pgfutil@tempdima=0.28pt%
  \advance\pgfutil@tempdima by.3\pgflinewidth%
  \pgfsetlinewidth{0.8\pgflinewidth}
  \pgfsetdash{}{+0pt}
  \pgfsetroundcap
  \pgfsetroundjoin
  \pgfpathmoveto{\pgfqpoint{-3\pgfutil@tempdima}{4\pgfutil@tempdima}}
  \pgfpathcurveto
  {\pgfqpoint{-2.75\pgfutil@tempdima}{2.5\pgfutil@tempdima}}
  {\pgfqpoint{0pt}{0.25\pgfutil@tempdima}}
  {\pgfqpoint{0.75\pgfutil@tempdima}{0pt}}
  \pgfpathcurveto
  {\pgfqpoint{0pt}{-0.25\pgfutil@tempdima}}
  {\pgfqpoint{-2.75\pgfutil@tempdima}{-2.5\pgfutil@tempdima}}
  {\pgfqpoint{-3\pgfutil@tempdima}{-4\pgfutil@tempdima}}
  \pgfusepathqstroke
}
\makeatother

% Shapes
\tikzset{diredge/.style={decoration={
  markings,
  mark=at position 0.525 with {\arrow{#1}}},postaction={decorate}}}
\tikzset{
    diredge/.default=>
}

\tikzset{diredgestart/.style={decoration={
  markings,
  mark=at position 4pt with {\arrow{#1}}},postaction={decorate}}}
\tikzset{
    diredgestart/.default=<
}


\tikzset{diredgeend/.style={decoration={
  markings,
  mark=at position 1 with {\arrow{#1}}},postaction={decorate}}}
\tikzset{
    diredgeend/.default=>
}


\makeatletter
\pgfdeclareshape{ground}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    % \saveddimen\myscale
    % {
    %   \pgfkeysgetvalue{/pgf/scale}{\minwidth}
    %   \pgf@x=\minwidth
    % }
    \anchor{north}
    {
        \pgf@x=0pt
        \pgf@y=0.5*0.33*\stateheight
    }
    \anchor{south}
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \saveddimen\overallwidth
    {
        \pgfkeysgetvalue{/pgf/minimum width}{\minwidth}
        \pgf@x=\minimumstatewidth
        \ifdim\pgf@x<\minwidth
            \pgf@x=\minwidth
        \fi
    }
    \backgroundpath
    {
        \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{1.25pt}
        \ifhflip
            \pgftransformyscale{-1}
        \fi
        \pgftransformscale{0.5}
        \pgfpathmoveto{\pgfpoint{-0.5*\overallwidth}{0}}
        \pgfpathlineto{\pgfpoint{0.5*\overallwidth}{0}}
        \pgfpathmoveto{\pgfpoint{-0.33*\overallwidth}{0.33*\stateheight}}
        \pgfpathlineto{\pgfpoint{0.33*\overallwidth}{0.33*\stateheight}}
        \pgfpathmoveto{\pgfpoint{-0.16*\overallwidth}{0.66*\stateheight}}
        \pgfpathlineto{\pgfpoint{0.16*\overallwidth}{0.66*\stateheight}}
        \pgfpathmoveto{\pgfpoint{-0.02*\overallwidth}{\stateheight}}
        \pgfpathlineto{\pgfpoint{0.02*\overallwidth}{\stateheight}}
        \pgfusepath{stroke}
        \end{pgfonlayer}
    }
}
\tikzset{forward arrow style/.style={every to/.style, decoration={
    markings,
    mark=at position 0.5*\pgfdecoratedpathlength+2pt with \arrow{>[\strarr]}},
    postaction=decorate}}
\tikzset{reverse arrow style/.style={every to/.style, decoration={
    markings,
    mark=at position 0.5*\pgfdecoratedpathlength+2pt with \arrow{<[\strarr]}},
    postaction=decorate}}
\pgfdeclareshape{morphismshape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    \saveddimen\savedlengthnw
    {
        \pgfkeysgetvalue{/tikz/keylengthnw}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthn
    {
        \pgfkeysgetvalue{/tikz/keylengthn}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthne
    {
        \pgfkeysgetvalue{/tikz/keylengthne}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthsw
    {
        \pgfkeysgetvalue{/tikz/keylengthsw}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengths
    {
        \pgfkeysgetvalue{/tikz/keylengths}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthse
    {
        \pgfkeysgetvalue{/tikz/keylengthse}{\len}
        \pgf@x=\len
    }
    \saveddimen\overallwidth
    {
        \pgfkeysgetvalue{/tikz/width}{\minwidth}
        \pgf@x=\wd\pgfnodeparttextbox
        \ifdim\pgf@x<\minwidth
            \pgf@x=\minwidth
        \fi
    }
    \savedanchor{\upperrightcorner}
    {
        \pgf@y=.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -.5\dp\pgfnodeparttextbox
        \pgf@x=.5\wd\pgfnodeparttextbox
    }
    \anchor{north}
    {
        \pgf@x=0pt
        \pgf@y=0.5\morphismheight
    }
    \anchor{north east}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
    }
    \anchor{east}
    {
        \pgf@x=\overallwidth
        \divide \pgf@x by 2
        \advance \pgf@x by 5pt
        \pgf@y=0pt
    }
    \anchor{west}
    {
        \pgf@x=-\overallwidth
        \divide \pgf@x by 2
        \advance \pgf@x by -5pt
        \pgf@y=0pt
    }
    \anchor{north west}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
    }
    \anchor{connect nw}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthnw
    }
    \anchor{connect ne}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthne
    }
    \anchor{connect sw}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengthsw
    }
    \anchor{connect se}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengthse
    }
    \anchor{connect n}
    {
        \pgf@x=0pt
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthn
    }
    \anchor{connect s}
    {
        \pgf@x=0pt
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengths
    }
    \anchor{south east}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
    }
    \anchor{south west}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
    }
    \anchor{south}
    {
        \pgf@x=0pt
        \pgf@y=-0.5\morphismheight
    }
    \anchor{text}
    {
        \upperrightcorner
        \pgf@x=-\pgf@x
        \pgf@y=-\pgf@y
    }
    \backgroundpath
    {
    \begin{scope}
        \pgfkeysgetvalue{/tikz/fill}{\morphismfill}
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{\thickness}
        \begin{scope}
            \begin{pgfonlayer}{morphismlayer}
        \pgfsetstrokecolor{black}
        \pgfsetfillcolor{\pgfkeysvalueof{/tikz/colour}}
        \pgfsetlinewidth{\thickness}
                \ifhflip
                    \pgftransformyscale{-1}
                \fi
                \ifvflip
                    \pgftransformxscale{-1}
                \fi
                \ifhvflip
                    \pgftransformxscale{-1}
                    \pgftransformyscale{-1}
                \fi
                \pgfpathmoveto{\pgfpoint
                    {-0.5*\overallwidth-5pt}
                    {0.5*\morphismheight}}
                \pgfpathlineto{\pgfpoint
                    {0.5*\overallwidth+5pt}
                    {0.5*\morphismheight}}
                \ifwedge
                    \pgfpathlineto{\pgfpoint
                        {0.5*\overallwidth + \wedgewidth}
                        {-0.5*\morphismheight}}
                \else
                    \pgfpathlineto{\pgfpoint
                        {0.5*\overallwidth + 5pt}
                        {-0.5*\morphismheight}}
                \fi
                \pgfpathlineto{\pgfpoint
                    {-0.5*\overallwidth-5pt}
                    {-0.5*\morphismheight}}
                \pgfpathclose
                \pgfusepath{fill,stroke}
            \end{pgfonlayer}
        \end{scope}
        \ifconnectnw
            \pgfpathmoveto{\pgfpoint
                {-0.4*\overallwidth}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {-0.4*\overallwidth}
                {0.5*\morphismheight+\savedlengthnw}}
            \pgfusepath{stroke}
        \fi
        \ifconnectne
            \pgfpathmoveto{\pgfpoint
                {0.4*\overallwidth}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0.4*\overallwidth}
                {0.5*\morphismheight+\savedlengthne}}
            \pgfusepath{stroke}
        \fi
        \ifconnectsw
            \pgfpathmoveto{\pgfpoint
                {-0.4*\overallwidth}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {-0.4*\overallwidth}
                {-0.5*\morphismheight-\savedlengthsw}}
            \pgfusepath{stroke}
        \fi
        \ifconnectse
            \pgfpathmoveto{\pgfpoint
                {0.4*\overallwidth}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0.4*\overallwidth}
                {-0.5*\morphismheight-\savedlengthse}}
            \pgfusepath{stroke}
        \fi
        \ifconnectn
            \pgfpathmoveto{\pgfpoint
                {0pt}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0pt}
                {0.5*\morphismheight+\savedlengthn}}
            \pgfusepath{stroke}
        \fi
        \ifconnects
            \pgfpathmoveto{\pgfpoint
                {0pt}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0pt}
                {-0.5*\morphismheight-\savedlengths}}
            \pgfusepath{stroke}
        \fi
        \ifconnectnwf
            \draw [forward arrow style] (-0.4*\overallwidth,0.5*\morphismheight)
                to (-0.4*\overallwidth,0.5*\morphismheight+\savedlengthnw);
        \fi
        \ifconnectnef
            \draw [forward arrow style] (0.4*\overallwidth,0.5*\morphismheight)
                to (0.4*\overallwidth,0.5*\morphismheight+\savedlengthne);
        \fi
        \ifconnectswf
            \draw [forward arrow style] (-0.4*\overallwidth,-0.5*\morphismheight-\savedlengthsw)
                to (-0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectsef
            \draw [forward arrow style] (0.4*\overallwidth,-0.5*\morphismheight-\savedlengthse)
                to (0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectnf
            \draw [forward arrow style] (0,0.5*\morphismheight)
                to (0,0.5*\morphismheight+\savedlengthn);
        \fi
        \ifconnectsf
            \draw [forward arrow style] (0,-0.5*\morphismheight-\savedlengths)
                to (0,-0.5*\morphismheight);
        \fi
        \ifconnectnwr
            \draw [reverse arrow style] (-0.4*\overallwidth,0.5*\morphismheight)
                to (-0.4*\overallwidth,0.5*\morphismheight+\savedlengthnw);
        \fi
        \ifconnectner
            \draw [reverse arrow style] (0.4*\overallwidth,0.5*\morphismheight)
                to (0.4*\overallwidth,0.5*\morphismheight+\savedlengthne);
        \fi
        \ifconnectswr
            \draw [reverse arrow style] (-0.4*\overallwidth,-0.5*\morphismheight-\savedlengthsw)
                to (-0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectser
            \draw [reverse arrow style] (0.4*\overallwidth,-0.5*\morphismheight-\savedlengthse)
                to (0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectnr
            \draw [reverse arrow style] (0,0.5*\morphismheight)
                to (0,0.5*\morphismheight+\savedlengthn);
        \fi
        \ifconnectsr
            \draw [reverse arrow style] (0,-0.5*\morphismheight-\savedlengths)
                to (0,-0.5*\morphismheight);
        \fi
    \end{scope}
%    \pgfsetstrokecolor{black}
%    \pgfsetfillcolor{black}
%    \pgfsetlinewidth{20pt}
    }
}
\tikzset{morphism/.style={morphismshape, node on layer=foreground}}
\pgfdeclareshape{dashedmorphismshape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    \saveddimen\savedlengthnw
    {
        \pgfkeysgetvalue{/tikz/keylengthnw}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthn
    {
        \pgfkeysgetvalue{/tikz/keylengthn}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthne
    {
        \pgfkeysgetvalue{/tikz/keylengthne}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthsw
    {
        \pgfkeysgetvalue{/tikz/keylengthsw}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengths
    {
        \pgfkeysgetvalue{/tikz/keylengths}{\len}
        \pgf@x=\len
    }
    \saveddimen\savedlengthse
    {
        \pgfkeysgetvalue{/tikz/keylengthse}{\len}
        \pgf@x=\len
    }
    \saveddimen\overallwidth
    {
        \pgfkeysgetvalue{/tikz/width}{\minwidth}
        \pgf@x=\wd\pgfnodeparttextbox
        \ifdim\pgf@x<\minwidth
            \pgf@x=\minwidth
        \fi
    }
    \savedanchor{\upperrightcorner}
    {
        \pgf@y=.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -.5\dp\pgfnodeparttextbox
        \pgf@x=.5\wd\pgfnodeparttextbox
    }
    \anchor{north}
    {
        \pgf@x=0pt
        \pgf@y=0.5\morphismheight
    }
    \anchor{north east}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
    }
    \anchor{east}
    {
        \pgf@x=\overallwidth
        \divide \pgf@x by 2
        \advance \pgf@x by 5pt
        \pgf@y=0pt
    }
    \anchor{west}
    {
        \pgf@x=-\overallwidth
        \divide \pgf@x by 2
        \advance \pgf@x by -5pt
        \pgf@y=0pt
    }
    \anchor{north west}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
    }
    \anchor{connect nw}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthnw
    }
    \anchor{connect ne}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthne
    }
    \anchor{connect sw}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengthsw
    }
    \anchor{connect se}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengthse
    }
    \anchor{connect n}
    {
        \pgf@x=0pt
        \pgf@y=0.5\morphismheight
        \advance\pgf@y by \savedlengthn
    }
    \anchor{connect s}
    {
        \pgf@x=0pt
        \pgf@y=-0.5\morphismheight
        \advance\pgf@y by -\savedlengths
    }
    \anchor{south east}
    {
        \pgf@x=\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
    }
    \anchor{south west}
    {
        \pgf@x=-\overallwidth
        \multiply \pgf@x by 2
        \divide \pgf@x by 5
        \pgf@y=-0.5\morphismheight
    }
    \anchor{south}
    {
        \pgf@x=0pt
        \pgf@y=-0.5\morphismheight
    }
    \anchor{text}
    {
        \upperrightcorner
        \pgf@x=-\pgf@x
        \pgf@y=-\pgf@y
    }
    \backgroundpath
    {
    \begin{scope}
        \pgfkeysgetvalue{/tikz/fill}{\morphismfill}
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{\thickness}
        \begin{scope}
            \begin{pgfonlayer}{dashedmorphismlayer}
        \pgfsetstrokecolor{black}
        \pgfsetdash{{3pt}{3pt}}{0pt}%new to test
        \pgfsetfillcolor{\pgfkeysvalueof{/tikz/colour}}
        \pgfsetlinewidth{\thickness}
                \ifhflip
                    \pgftransformyscale{-1}
                \fi
                \ifvflip
                    \pgftransformxscale{-1}
                \fi
                \ifhvflip
                    \pgftransformxscale{-1}
                    \pgftransformyscale{-1}
                \fi
                \pgfpathmoveto{\pgfpoint
                    {-0.5*\overallwidth-5pt}
                    {0.5*\morphismheight}}
                \pgfpathlineto{\pgfpoint
                    {0.5*\overallwidth+5pt}
                    {0.5*\morphismheight}}
                \ifwedge
                    \pgfpathlineto{\pgfpoint
                        {0.5*\overallwidth + \wedgewidth}
                        {-0.5*\morphismheight}}
                \else
                    \pgfpathlineto{\pgfpoint
                        {0.5*\overallwidth + 5pt}
                        {-0.5*\morphismheight}}
                \fi
                \pgfpathlineto{\pgfpoint
                    {-0.5*\overallwidth-5pt}
                    {-0.5*\morphismheight}}
                \pgfpathclose
                \pgfusepath{fill,stroke}
            \end{pgfonlayer}
        \end{scope}
        \ifconnectnw
            \pgfpathmoveto{\pgfpoint
                {-0.4*\overallwidth}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {-0.4*\overallwidth}
                {0.5*\morphismheight+\savedlengthnw}}
            \pgfusepath{stroke}
        \fi
        \ifconnectne
            \pgfpathmoveto{\pgfpoint
                {0.4*\overallwidth}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0.4*\overallwidth}
                {0.5*\morphismheight+\savedlengthne}}
            \pgfusepath{stroke}
        \fi
        \ifconnectsw
            \pgfpathmoveto{\pgfpoint
                {-0.4*\overallwidth}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {-0.4*\overallwidth}
                {-0.5*\morphismheight-\savedlengthsw}}
            \pgfusepath{stroke}
        \fi
        \ifconnectse
            \pgfpathmoveto{\pgfpoint
                {0.4*\overallwidth}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0.4*\overallwidth}
                {-0.5*\morphismheight-\savedlengthse}}
            \pgfusepath{stroke}
        \fi
        \ifconnectn
            \pgfpathmoveto{\pgfpoint
                {0pt}
                {0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0pt}
                {0.5*\morphismheight+\savedlengthn}}
            \pgfusepath{stroke}
        \fi
        \ifconnects
            \pgfpathmoveto{\pgfpoint
                {0pt}
                {-0.5*\morphismheight}}
            \pgfpathlineto{\pgfpoint
                {0pt}
                {-0.5*\morphismheight-\savedlengths}}
            \pgfusepath{stroke}
        \fi
        \ifconnectnwf
            \draw [forward arrow style] (-0.4*\overallwidth,0.5*\morphismheight)
                to (-0.4*\overallwidth,0.5*\morphismheight+\savedlengthnw);
        \fi
        \ifconnectnef
            \draw [forward arrow style] (0.4*\overallwidth,0.5*\morphismheight)
                to (0.4*\overallwidth,0.5*\morphismheight+\savedlengthne);
        \fi
        \ifconnectswf
            \draw [forward arrow style] (-0.4*\overallwidth,-0.5*\morphismheight-\savedlengthsw)
                to (-0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectsef
            \draw [forward arrow style] (0.4*\overallwidth,-0.5*\morphismheight-\savedlengthse)
                to (0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectnf
            \draw [forward arrow style] (0,0.5*\morphismheight)
                to (0,0.5*\morphismheight+\savedlengthn);
        \fi
        \ifconnectsf
            \draw [forward arrow style] (0,-0.5*\morphismheight-\savedlengths)
                to (0,-0.5*\morphismheight);
        \fi
        \ifconnectnwr
            \draw [reverse arrow style] (-0.4*\overallwidth,0.5*\morphismheight)
                to (-0.4*\overallwidth,0.5*\morphismheight+\savedlengthnw);
        \fi
        \ifconnectner
            \draw [reverse arrow style] (0.4*\overallwidth,0.5*\morphismheight)
                to (0.4*\overallwidth,0.5*\morphismheight+\savedlengthne);
        \fi
        \ifconnectswr
            \draw [reverse arrow style] (-0.4*\overallwidth,-0.5*\morphismheight-\savedlengthsw)
                to (-0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectser
            \draw [reverse arrow style] (0.4*\overallwidth,-0.5*\morphismheight-\savedlengthse)
                to (0.4*\overallwidth,-0.5*\morphismheight);
        \fi
        \ifconnectnr
            \draw [reverse arrow style] (0,0.5*\morphismheight)
                to (0,0.5*\morphismheight+\savedlengthn);
        \fi
        \ifconnectsr
            \draw [reverse arrow style] (0,-0.5*\morphismheight-\savedlengths)
                to (0,-0.5*\morphismheight);
        \fi
    \end{scope}
%    \pgfsetstrokecolor{black}
%    \pgfsetfillcolor{black}
%    \pgfsetlinewidth{20pt}
    }
}
\tikzset{dashedmorphism/.style={dashedmorphismshape, node on layer=foreground}}
\pgfdeclareshape{swish right}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    \anchor{north}
    {
        \pgf@x=\minimummorphismwidth
        \divide\pgf@x by 5
        \pgf@y=\morphismheight
        \divide\pgf@y by 2
        \advance\pgf@y by \connectheight
    }
    \anchor{south}
    {
        \pgf@x=-\minimummorphismwidth
        \divide\pgf@x by 5
        \pgf@y=-\morphismheight
        \divide\pgf@y by 2
        \advance\pgf@y by -\connectheight
    }
    \backgroundpath
    {
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint
            {-0.2*\minimummorphismwidth}
            {-0.5*\morphismheight-\connectheight}}
        \pgfpathcurveto
            {\pgfpoint{-0.2*\minimummorphismwidth}{0pt}}
            {\pgfpoint{0.2*\minimummorphismwidth}{0pt}}
            {\pgfpoint
                {0.2*\minimummorphismwidth}
                {0.5*\morphismheight+\connectheight}}
        \pgfusepath{stroke}
    }
}
\pgfdeclareshape{swish left}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    \anchor{north}
    {
        \pgf@x=-\minimummorphismwidth
        \divide\pgf@x by 5
        \pgf@y=\morphismheight
        \divide\pgf@y by 2
        \advance\pgf@y by \connectheight
    }
    \anchor{south}
    {
        \pgf@x=\minimummorphismwidth
        \divide\pgf@x by 5
        \pgf@y=-\morphismheight
        \divide\pgf@y by 2
        \advance\pgf@y by -\connectheight
    }
    \backgroundpath
    {
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint
            {0.2*\minimummorphismwidth}
            {-0.5*\morphismheight-\connectheight}}
        \pgfpathcurveto
            {\pgfpoint{0.2*\minimummorphismwidth}{0pt}}
            {\pgfpoint{-0.2*\minimummorphismwidth}{0pt}}
            {\pgfpoint
                {-0.2*\minimummorphismwidth}
                {0.5*\morphismheight+\connectheight}}
        \pgfusepath{stroke}
    }
}
\pgfdeclareshape{state}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchorborder{\centerpoint}
    \saveddimen\overallwidth
    {
        \pgf@x=3\wd\pgfnodeparttextbox
        \ifdim\pgf@x<\minimumstatewidth
            \pgf@x=\minimumstatewidth
        \fi
    }
    \savedanchor{\upperrightcorner}
    {
        \pgf@x=.5\wd\pgfnodeparttextbox
        \pgf@y=.5\ht\pgfnodeparttextbox
        \advance\pgf@y by -.5\dp\pgfnodeparttextbox
    }
    \anchor{north}
    {
        \pgf@x=0pt
        \pgf@y=0pt%\stateheight
    }
    \anchor{south}
    {
        \pgf@x=0pt
        \pgf@y=0pt%-\stateheight
    }
    \anchor{A}
    {
        \pgf@x=-\overallwidth
        \divide\pgf@x by 4
        \pgf@y=0pt
    }
    \anchor{B}
    {
        \pgf@x=\overallwidth
        \divide\pgf@x by 4
        \pgf@y=0pt
    }
    \anchor{text}
    {
        \upperrightcorner
        \pgf@x=-\pgf@x
        \ifhflip
            \pgf@y=-\pgf@y
            \advance\pgf@y by 0.4\stateheight
        \else
            \pgf@y=-\pgf@y
            \advance\pgf@y by -0.4\stateheight
        \fi
    }
    \backgroundpath
    {
       \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint{-0.5*\overallwidth}{0}}
        \pgfpathlineto{\pgfpoint{0.5*\overallwidth}{0}}
        \ifhflip
            \pgfpathlineto{\pgfpoint{0}{\stateheight}}
        \else
            \pgfpathlineto{\pgfpoint{0}{-\stateheight}}
        \fi
        \pgfpathclose
        \ifblack
            \pgfsetfillcolor{black!50}
            \pgfusepath{fill,stroke}
        \else
            \pgfusepath{stroke}
        \fi
       \end{pgfonlayer}
    }
}
\makeatother

% Little pictures
\newcommand{\tinydecoherence}[1][triangle]{
\smash{\raisebox{0pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.33]
    \node (0) at (0,0) {};
    \node[#1, inner sep=1.5pt,scale=2] (1) at (0,0.4) {};
    \node (2) at (0,1) {};
    \draw (1.north) to (2.center);
    \draw (0.center) to (1.south);
\end{pic}
}\hspace{-1pt}}}}
\newcommand{\tinydot}[1]{%doesn't work atm, not that I need it
\smash{\ensuremath{\begin{pic}
    \node[#1, inner sep=1.25pt] {};
\end{pic}
}}}
\newcommand{\tinycomult}[1][dot]{
\smash{\raisebox{-1pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.33]
    \node (0) at (0,0) {};
    \node[#1, inner sep=1.5pt] (1) at (0,0.55) {};
    \node (2) at (-0.5,1) {};
    \node (3) at (0.5,1) {};
    \draw (0.center) to (1.center);
    \draw (1.center) to [out=left, in=down, out looseness=1.5] (2.center);
    \draw (1.center) to [out=right, in=down, out looseness=1.5] (3.center);
\end{pic}
}\hspace{-3pt}}}}
\newcommand{\tinycomultunit}[1][dot]{
\smash{\raisebox{-1pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.33]
    \node[#1, inner sep=1.5pt] (0) at (0,0) {};
    \node[#1, inner sep=1.5pt] (1) at (0,0.55) {};
    \node (2) at (-0.5,1) {};
    \node (3) at (0.5,1) {};
    \draw (0.center) to (1.center);
    \draw (1.center) to [out=left, in=down, out looseness=1.5] (2.center);
    \draw (1.center) to [out=right, in=down, out looseness=1.5] (3.center);
\end{pic}
}\hspace{-3pt}}}}
\newcommand{\tinymultcounit}[1][dot]{
\smash{\raisebox{-1pt}{\hspace{-2pt}\ensuremath{\begin{pic}[xscale=0.33,yscale=-0.33]
    \node[#1, inner sep=1.5pt] (0) at (0,0) {};
    \node[#1, inner sep=1.5pt] (1) at (0,0.55) {};
    \node (2) at (-0.5,1) {};
    \node (3) at (0.5,1) {};
    \draw (0.center) to (1.center);
    \draw (1.center) to [out=left, in=down, out looseness=1.5] (2.center);
    \draw (1.center) to [out=right, in=down, out looseness=1.5] (3.center);
\end{pic}
}\hspace{-3pt}}}}
\newcommand{\tinycounit}[1][dot]{
\smash{\raisebox{-1pt}{\ensuremath{\hspace{0pt}\begin{pic}[scale=0.33]
        \node (0) at (0,0) {};
        \node (1) at (0,1) {};
        \node[#1, inner sep=1.5pt] (d) at (0,0.55) {};
        \draw (0.center) to (d.center);
    \end{pic}
    \hspace{-1pt}}}}}
\newcommand{\tinymult}[1][dot]{
\smash{\raisebox{-1pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.33,yscale=-1]
    \node (0) at (0,0) {};
    \node[#1, inner sep=1.5pt] (1) at (0,0.55) {};
    \node (2) at (-0.5,1) {};
    \node (3) at (0.5,1) {};
    \draw (0.center) to (1.center);
    \draw (1.center) to [out=left, in=down, out looseness=1.5] (2.center);
    \draw (1.center) to [out=right, in=down, out looseness=1.5] (3.center);
\end{pic}
}\hspace{-3pt}}}}
\newcommand{\tinyunit}[1][dot]{
\smash{\raisebox{-1pt}{\ensuremath{\hspace{0pt}\begin{pic}[scale=0.33,yscale=-1]
        \node (0) at (0,0) {};
        \node (1) at (0,1) {};
        \node[#1, inner sep=1.5pt] (d) at (0,0.55) {};
        \draw (0.center) to (d.center);
    \end{pic}
    \hspace{-1pt}}}}}
\newcommand{\tinyid}{\raisebox{-1pt}{\ensuremath{\hspace{-2pt}\begin{pic}[scale=0.33]
        \node (0) at (0,0) {};
        \node (1) at (0,1) {};
        \draw[string] (0.center) to (1.center);
     \end{pic}
     \hspace{-2pt}}}}
\newcommand{\tinyhandle}[1][dot]{\ensuremath{\smash{\raisebox{-1pt}{\ensuremath{\hspace{-2pt}\begin{pic}[scale=0.33]
        \node (0) at (0,0) {};
        \node[dot, inner sep=1.0pt] (1) at (0,0.3) {};
        \node[dot, inner sep=1.0pt] (2) at (0,0.7) {};
        \node (3) at (0,1) {};
        \draw (0.center) to (1.center);
        \draw (2.center) to (3.center);
        \draw[in=180, out=180, looseness=2] (1.center) to (2.center);
        \draw[in=0, out=0, looseness=2] (1.center) to (2.center);
\end{pic}\hspace{-1pt}}}}}}
\newcommand{\tinyblackwhitehandle}{\smash{\raisebox{-1pt}{\ensuremath{\hspace{-2pt}\begin{pic}[scale=0.33]
        \node (0) at (0,0) {};
        \node[whitedot, inner sep=1.0pt] (1) at (0,0.3) {};
        \node[blackdot, inner sep=1.0pt] (2) at (0,0.7) {};
        \node (3) at (0,1) {};
        \draw (0.center) to (1.center);
        \draw (2.center) to (3.center);
        \draw[in=180, out=180, looseness=2] (1.center) to (2.center);
        \draw[in=0, out=0, looseness=2] (1.center) to (2.center);
\end{pic}\hspace{-1pt}}}}}
\newcommand{\tinybraid}{\smash{\raisebox{-1pt}{\ensuremath{\hspace{-2pt}\begin{pic}[scale=0.3]
        \draw (0,0) to[out=90,in=-90] (1,1);
        \draw[braid,line width=1.5*\thickness] (1,0) to[out=90,in=-90] (0,1);
\end{pic}\hspace{-1pt}}}}}
\newcommand{\tinysymmetry}{\smash{\raisebox{-1pt}{\ensuremath{\hspace{-1pt}\begin{pic}[scale=0.3]
        \draw (1,0) to[out=90,in=-90] (0,1);
        \draw (0,0) to[out=90,in=-90] (1,1);
\end{pic}}}}}
\newcommand{\tinypants}{\smash{\raisebox{-1pt}{\hspace{-1pt}\ensuremath{\begin{pic}[scale=0.17]
    \draw (0,0) to [out=up, in=down] (1,2);
    \draw (1,0) to [out=up, in=up, looseness=2] (2,0);
    \draw (3,0) to[out=up, in=down] (2,2);
\end{pic}}}}}
%\newcommand{\tinycup}{\smash{\raisebox{0pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.17]
%    \draw (0,0) to[out=-90,in=-90,looseness=2] (1.5,0);
%\end{pic}}}}}
\newcommand{\tinycup}{\begin{pic}[scale=0.17]
    \draw (0,0) to[out=-90,in=-90,looseness=2] (1.5,0);
\end{pic}}
\newcommand{\tinycap}{\smash{\raisebox{0pt}{\hspace{-2pt}\ensuremath{\begin{pic}[scale=0.17]
    \draw (0,0) to[out=90,in=90,looseness=2] (1.5,0);
\end{pic}}}}}
\newcommand{\tinymultmult}[2]{\smash{\raisebox{0pt}{\hspace{-2pt}\ensuremath{\begin{pic}[xscale=0.17,yscale=-.17]
  \draw (2,0) to (2,1) node [#1,inner sep=1.5pt] {} to [out=left, in=down] (1,2);
  \draw (2,1) to [out=right, in=down] (3,2);
  \draw[braid, line width=1.5*\thickness] (.5,1) to [out=right, in=down] (1.5,2);
  \draw (.5,0) to (.5,1) node [#2, inner sep=1.5pt] {} to [out=left, in=down] (-.5,2);
\end{pic}}}}}
\newcommand{\tinyground}[1][ground]{\begin{pic}[scale=0.4]
    \node[#1, scale=0.6] (1) at (0,0.4) {};
    \draw [pure] (1.south) to +(0,-.3);
\end{pic}
}
%\newcommand{\tinyground}[1][ground]{
%\smash{\raisebox{-2pt}{\hspace{-3pt}\ensuremath{\begin{pic}[scale=0.4]
%    \node[#1, scale=0.6] (1) at (0,0.4) {};
%    \draw [pure] (1.south) to +(0,-.3);
%\end{pic}
%}}}}

\newcommand{\tinymix}[1][ground]{
\smash{\raisebox{-2pt}{\hspace{-3pt}\ensuremath{\begin{pic}[scale=-0.4]
    \node[#1, scale=-0.6] (1) at (0,0.4) {};
    \draw [pure] (1.south) to +(0,-.3);
\end{pic}
}}}}
\newcommand{\tinyring}{
\smash{\raisebox{-2pt}{\hspace{-3pt}\ensuremath{\begin{pic}[scale=0.5]
    \draw[diredge=<] (1.4,0.5) to[out=-90,in=0] (1.15,0.25) to[out=180,in=-90] (0.9,0.5) to[out=90,in=180] (1.15,0.75) to[out=0,in=90] (1.4,0.5);
\end{pic}
}\hspace{-1pt}}}}
    
\makeatletter
\pgfdeclareshape{arrow shape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchor{south}{\centerpoint}
    \anchor{north}{\centerpoint}
    \anchorborder{\centerpoint}
    \backgroundpath
    {
        \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetarrowsstart{>[\strarr]}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint{0}{-2pt}}
        \pgfpathlineto{\pgfpoint{0}{1pt}}
        \pgfusepath{stroke}
        \end{pgfonlayer}
    }
}
\pgfdeclareshape{double arrow shape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchor{south}{\centerpoint}
    \anchor{north}{\centerpoint}
    \anchorborder{\centerpoint}
    \backgroundpath
    {
        \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetarrowsstart{>[\strarr]}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint{0}{-3.5pt}}
        \pgfpathlineto{\pgfpoint{0}{-0.5pt}}
        \pgfusepath{stroke}
        \pgfpathmoveto{\pgfpoint{0}{-0.5pt}}
        \pgfpathlineto{\pgfpoint{0}{2.5pt}}
        \pgfusepath{stroke}
        \end{pgfonlayer}
    }
}
\pgfdeclareshape{reverse arrow shape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchor{south}{\centerpoint}
    \anchor{north}{\centerpoint}
    \anchorborder{\centerpoint}
    \backgroundpath
    {
        \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetarrowsstart{<[\strarr]}
        \pgfsetlinewidth{\thickness}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint{0}{-2pt}}
        \pgfpathlineto{\pgfpoint{0}{-1pt}}
        \pgfusepath{stroke}
        \end{pgfonlayer}
    }
}
\pgfdeclareshape{reverse double arrow shape}
{
    \savedanchor\centerpoint
    {
        \pgf@x=0pt
        \pgf@y=0pt
    }
    \anchor{center}{\centerpoint}
    \anchor{south}{\centerpoint}
    \anchor{north}{\centerpoint}
    \anchorborder{\centerpoint}
    \backgroundpath
    {
        \begin{pgfonlayer}{foreground}
        \pgfsetstrokecolor{black}
        \pgfsetarrowsstart{<[\strarr]}
        \pgfsetlinewidth{\thickness}
        \pgfpathmoveto{\pgfpoint{0}{-3.5pt}}
        \pgfpathlineto{\pgfpoint{0}{-0.5pt}}
        \pgfusepath{stroke}
        \pgfpathmoveto{\pgfpoint{0}{-0.5pt}}
        \pgfpathlineto{\pgfpoint{0}{2.5pt}}
        \pgfusepath{stroke}
        \end{pgfonlayer}
    }
}
\makeatother

\tikzset{arrow/.pic={
    \path[pic actions, decoration={ markings,
      mark=at position 1 with {\arrow{>[\strarr]}}
    },
    postaction={decorate}] (0,1pt) -- (0,2pt);
},double arrow/.pic={
    \path[pic actions, decoration={ markings,
      mark=at position \pgfdecoratedpathlength-3pt with {\arrow{>[\strarr]}},
      mark=at position \pgfdecoratedpathlength with {\arrow{>[\strarr]}}
    },
    postaction={decorate}] (0,-6pt) -- (0,4pt);
},
  reverse arrow/.pic={
    \path[pic actions, decoration={ markings,
      mark=at position 1 with {\arrow{<[\strarr]}}
    },
    postaction={decorate}] (0,1pt) -- (0,2pt);
}
}

%\def\endend{\end{document}\end{document}\end{document}\end{document}}

%% CHAPTER 8 MACROS
\def\redbox{black}
\def\greenbox{white}
\tikzset{surface picture/.style={xscale={0.6}, yscale=0.8, line width=\thickness}}
\tikzset{three dimensional picture/.style={}}
\setlength\minimummorphismwidth{0.1cm}
%\setlength\morphismheight{0.4cm}
\tikzset{morphismtwocell/.style={morphism, width=0.5cm, connect ne length=0cm, connect se length=0cm, connect nw length=0cm, connect sw length=0cm}}
\tikzset{nmorphismtwocell/.style={draw, minimum width=0.8cm, connect ne length=0cm, connect se length=0cm, connect nw length=0cm, connect sw length=0cm}}
\def\xoff{0.15cm}
\def\yoff{0.1cm}
\def\ang{90}
%\tikzset{dashback/.style={densely dashed, black!60}}
\tikzset{dashback/.style={black!40}}
%\tikzset{dashback/.style={densely dashed, black}}
\def\bloose{0.25}
\def\tloose{0.25}
\tikzset{shade 1 local/.style={shade 1}}
\tikzset{shade 2 local/.style={shade 2}}
\def\lefteffect{
\path [rectangle, fill=white] ([xshift=-\xoff, yshift=-\yoff] bl.center) rectangle +(2*\xoff,2*\yoff);
\path [shade 2 local] ([yshift=0.1cm] br.center) to +(0,-0.1cm) to [out=-\ang, in=right, out looseness=\bloose] ([xshift=\xoff, yshift=-\yoff] bl.center) to +(0,2*\yoff);
\draw [black!40] (br.center) to [out=\ang, in=right, out looseness=\bloose] ([xshift=\xoff, yshift=\yoff] bl.center) node (p) {};
\path [draw] ([yshift=0.1cm] br.center) to +(0,-0.1cm) to [out=-\ang, in=right, out looseness=\bloose] ([xshift=\xoff, yshift=-\yoff] bl.center) to +(0,2*\yoff);
\draw [shade 1 local] ([xshift=\xoff, yshift=\yoff] bl.center) to ++(-2*\xoff,0) to ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) -- cycle;
\path [shade 1 local] ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) to [out=right, in=\ang, in looseness=\tloose] (tr.center) to [out=-\ang, in=right, out looseness=\tloose] ([xshift=\xoff, yshift=-\yoff] tl.center);
\draw ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) to [out=right, in=\ang, in looseness=\tloose] (tr.center) to +(0,-0.1cm);
\draw (tr.center) to [out=-\ang, in=right, out looseness=\tloose] ([xshift=\xoff, yshift=-\yoff] tl.center) to +(0,-0.1cm);
}
\def\righteffect{
\path [shade 2 local] ([xshift=-\xoff, yshift=\yoff] tr.center) to [out=left, in=\ang, in looseness=\tloose] (tl.center) to [out=-\ang, in=left, out looseness=\tloose] ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [rectangle, fill=white] ([xshift=-\xoff, yshift=-\yoff] tr.center) rectangle +(2*\xoff,2*\yoff);
\draw (tl.center) to [out=up, in=left, out looseness=\tloose] ([xshift=-\xoff, yshift=\yoff] tr.center) to ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [shade 1 local] ([yshift=0.0cm] bl.center) to [out=-\ang, in=left, out looseness=\bloose] ([xshift=\xoff, yshift=-\yoff] br.center) to +(0,2*\yoff) to [out=left, in=\ang, in looseness=\bloose] (bl.center);
\path [shade 1 local] ([xshift=\xoff, yshift=-\yoff] tr.center) to ([xshift=\xoff, yshift=-\yoff] br.center) to +(-2*\xoff,0) to ([xshift=-\xoff, yshift=-\yoff] tr.center);
\draw [black!40] (bl.center) to [out=\ang, in=left, out looseness=\bloose] ([xshift=-\xoff, yshift=\yoff] br.center) to ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [draw] ([yshift=0.1cm] bl.center) to (bl.center) to [out=-\ang, in=left, out looseness=\bloose] ([xshift=\xoff, yshift=-\yoff] br.center) to ([xshift=\xoff, yshift=-\yoff] tr.center) to ([xshift=-\xoff, yshift=-\yoff] tr.center) to [out=left, in=-\ang, in looseness=\tloose] (tl.center);
}
\def\toplefteffect{
\path [rectangle, fill=white] ([xshift=-\xoff, yshift=-\yoff] bl.center) rectangle +(2*\xoff,2*\yoff);
\path [shade 2 local] ([yshift=\yoff] br.center) to ([yshift=-\yoff] br.center) to ([xshift=\xoff, yshift=-\yoff] bl.center) to +(0,2*\yoff);
\draw [black!40] ([yshift=\yoff] br.center) to ([xshift=\xoff, yshift=\yoff] bl.center) node (p) {};
\path [draw] ([yshift=-\yoff] br.center) to ([xshift=\xoff, yshift=-\yoff] bl.center) to +(0,2*\yoff);
\draw [shade 1 local] ([xshift=\xoff, yshift=\yoff] bl.center) to ++(-2*\xoff,0) to ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) -- cycle;
\path [shade 1 local] ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) to [out=right, in=\ang, in looseness=\tloose] (tr.center) to [out=-\ang, in=right, out looseness=\tloose] ([xshift=\xoff, yshift=-\yoff] tl.center);
\draw ([xshift=-\xoff, yshift=\yoff] tl.center) to ++(2*\xoff,0) to [out=right, in=\ang, in looseness=\tloose] (tr.center) to +(0,-0.1cm);
\draw (tr.center) to [out=-\ang, in=right, out looseness=\tloose] ([xshift=\xoff, yshift=-\yoff] tl.center) to +(0,-0.1cm);
}
\def\toprighteffect{
\path [shade 1 local] ([xshift=-\xoff, yshift=\yoff] tr.center) to [out=left, in=\ang, in looseness=\tloose] (tl.center) to [out=-\ang, in=left, out looseness=\tloose] ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [rectangle, fill=white] ([xshift=-\xoff, yshift=-\yoff] tr.center) rectangle +(2*\xoff,2*\yoff);
\draw (tl.center) to [out=up, in=left, out looseness=\tloose] ([xshift=-\xoff, yshift=\yoff] tr.center) to ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [shade 2 local] ([yshift=\yoff] bl.center) to ([yshift=-\yoff] bl.center) to ([xshift=\xoff, yshift=-\yoff] br.center) to +(0,2*\yoff);
\path [shade 2 local] ([xshift=\xoff, yshift=-\yoff] tr.center) to ([xshift=\xoff, yshift=-\yoff] br.center) to +(-2*\xoff,0) to ([xshift=-\xoff, yshift=-\yoff] tr.center);
\draw [black!40] ([yshift=\yoff] bl.center) -- ([xshift=-\xoff, yshift=\yoff] br.center) -- ([xshift=-\xoff, yshift=-\yoff] tr.center);
\path [draw] ([yshift=-\yoff] bl.center) to ([xshift=\xoff, yshift=-\yoff] br.center) to ([xshift=\xoff, yshift=-\yoff] tr.center) to ([xshift=-\xoff, yshift=-\yoff] tr.center) to [out=left, in=-\ang, in looseness=\tloose] (tl.center);
}
\newcommand\topcircle[1]{\draw [shade 1, thick] ([xshift=-0.5cm] #1) ellipse [x radius=0.5cm, y radius=\yoff];}
\newcommand\bottomcircle[1]{
\draw [shade 2, draw=none] (#1) arc [x radius=0.5cm, y radius=\yoff, start angle=0, end angle=-360];
\draw [shade 2] (#1) arc [x radius=0.5cm, y radius=\yoff, start angle=0, end angle=-180];
\draw [dashback] (#1) arc [x radius=0.5cm, y radius=\yoff, start angle=0, end angle=180];}

